# 事务

事务是一组操作的集合，它是一个不可分割的工作单位。事务会将所有的操作作为一个整体一起向系统提交或撤销操作请求。即这些操作要么同时成功。要么同时失败。

>  开启事务 => 如果抛异常则回滚事务 => 提交事务

默认的mysql事务是自动提交的，也就是说执行增删改操作默认会自动提交。

## 手动开启事务提交

```sql
set @@autocommit = 0; -- 设置为手动提交

start transaction; -- 开启事务 2
begin; -- 开启事务 3

... dml操作

commit; -- 提交

rollback; -- 回滚
```

## 事务的四大特性

ACID

1. **原子性**：一组操作，要么全部成功，要么全部失败
2. **一致性**：事务完成时，必须使所有的数据都保持一致状态
3. **隔离性**：保证事务在不受外部并发操作影响的独立环境运行。
4. **持久性**：事务一旦提交或者回滚，它对数据库中的数据的改变就是永久的。

## 并发事务问题

1. **脏读**： 一个事务读到另外一个事务还没有提交的数据。
2. **不可重复读**： 一个事务先后读取同一条记录，但两次读取的数据不同，称之为不可重复读。
3. **幻读**：一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了"幻影"。

## 事务隔离级别

| 隔离级别                     | 脏读 | 不可重复读 | 幻读 |
| ---------------------------- | ---- | ---------- | ---- |
| Read uncommitted （性能好）  | √    | √          | √    |
| Read committed               | X    | √          | √    |
| Repeatable Read(mysql的默认) | X    | X          | √    |
| Serializable （性能差）      | X    | X          | X    |

```sql
-- 查看事务隔离级别
select @@transaction_isolation;
-- 设置事务隔离界别
set [session | global] transaction isolation level {read uncommitted | read committed | repeatable read | serializable}
```

